<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>3D World</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="importmap">
  {
    "imports": {
      "three": "https://esm.sh/three@0.158.0",
      "nipplejs": "https://esm.sh/nipplejs@0.9.0"
    }
  }
  </script>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="ui">
    <div id="left-joystick" class="joystick"></div>
    <div id="right-touch" class="touch-area"></div>

    <!-- Epilepsy / Photo-sensitivity warning overlay (blocks interaction until accepted) -->
    <div id="warning-overlay" role="dialog" aria-modal="true" aria-live="polite">
      <div class="warning-panel">
        <h2>Warning</h2>
        <p>This project may contain flashing lights or rapid color changes. If you have a history of epilepsy or are sensitive to flashing lights, do not play.</p>
        <div class="warning-actions">
          <button id="warning-accept" type="button">I Understand — Continue</button>
          <button id="warning-decline" type="button">Do Not Play</button>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <div id="hud">
      <div id="fps">— FPS</div>
      
    </div>

    <!-- Asset highlight (top-right middle) -->
    <div id="asset-highlight" aria-live="polite" role="status" style="display:none;">
      <div class="asset-panel">
        <div id="asset-name" style="font-weight:800;">—</div>
        <div id="asset-info" style="font-size:12px; opacity:0.9;">Hover an object to see details</div>
      </div>
    </div>

    <!-- OUT-OF-BOUNDS HUD (moved out of #hud so it's centered at the top middle) -->
    <div id="oob" aria-live="polite" role="status"></div>

    <!-- Achievement / Notification (bottom-right) -->
    <div id="achievement" role="status" aria-live="polite" aria-hidden="true">
      <div class="achievement-window pause-panel">
        <div class="ach-title">Achievement Unlocked</div>
        <div class="ach-sub">I can read!</div>
      </div>
    </div>

    <!-- Pause button (top-right) -->
    <button id="pause-btn" aria-label="Pause" title="Pause" type="button">⏸</button>

    <!-- Pause menu overlay -->
    <div id="pause-menu" aria-hidden="true" role="dialog">
      <div class="pause-panel" id="pause-main">
        <h3>Paused</h3>
        <div class="pause-actions">
          <button id="resume-btn" type="button">Resume</button>
          <button id="settings-btn" type="button">Settings</button>
          <button id="quit-btn" type="button">Quit</button>
        </div>
        <div class="hint">Press Esc to toggle</div>
      </div>

      <!-- Settings panel (hidden by default) -->
      <div class="pause-panel settings-panel" id="settings-panel" aria-hidden="true">
        <h3>Settings</h3>

        <!-- Simple tabs: General | Environment -->
        <div class="settings-tabs" role="tablist" aria-label="Settings Tabs" style="display:flex; gap:8px; justify-content:center; margin-bottom:10px;">
          <button class="tab-btn active" data-tab="general" type="button" style="pointer-events:auto; padding:8px 10px; border-radius:8px; border:0; background:var(--accent); color:#04201b; font-weight:700;">General</button>
          <button class="tab-btn" data-tab="env" type="button" style="pointer-events:auto; padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:var(--ui);">Environment</button>
          <button class="tab-btn" data-tab="controls" type="button" style="pointer-events:auto; padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:var(--ui);">Controls</button>

          <button class="tab-btn" data-tab="achievements" type="button" style="pointer-events:auto; padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:var(--ui);">Achievements</button>
        </div>

        <!-- General tab content -->
        <div id="settings-tab-general">
          <div class="control-row">
            <label for="mouse-sens">Mouse Sens.</label>
            <input id="mouse-sens" type="range" min="0.5" max="4" step="0.1" />
            <span id="mouse-sens-val">1.0</span>
          </div>

          <div class="control-row">
            <label for="touch-sens">Touch Sens.</label>
            <input id="touch-sens" type="range" min="0.5" max="4" step="0.1" />
            <span id="touch-sens-val">1.0</span>
          </div>
          <div class="control-row toggle-row">
            <label for="invert-y">Invert Y</label>
            <input id="invert-y" type="checkbox" />
          </div>

          <!-- DANGER ZONE for asset highlight (moved below Invert Y) -->
          <div style="margin-top:6px; text-align:left;">
            <!-- Divider above the danger zone -->
            <div class="divider" aria-hidden="true" style="margin:8px 0;"></div>

            <div style="color:#ff7b7b; font-weight:900; font-size:13px; margin-bottom:6px; text-shadow:0 0 10px rgba(255,80,80,0.95);">
              DANGER ZONE
            </div>

            <div class="control-row toggle-row">
              <div class="danger-zone" style="width:100%;">
                <label for="show-asset-highlight" style="margin:0; display:inline-block;">Show asset on highlight</label>
                <input id="show-asset-highlight" type="checkbox" style="margin-left:8px;" />
                <div class="danger-note" style="margin-top:6px; font-size:12px; color:rgba(255,255,255,0.85);">
                  Displays a UI overlay when hovering objects — may reveal object positions.
                  <div style="margin-top:6px; font-size:12px; font-weight:800; color:#ffb3b3; text-shadow:0 0 6px rgba(255,80,80,0.85);">
                    MAY CRASH THE GAME OR MAKE IT IRRESPONSIVE
                  </div>
                </div>
              </div>
            </div>

            <!-- Divider below the danger zone -->
            <div class="divider" aria-hidden="true" style="margin:10px 0;"></div>
          </div>

          <!-- Back button for General tab -->
          <div class="pause-actions" style="margin-top:10px; justify-content:center;">
            <button id="settings-back-general" type="button" style="min-width:120px; background:rgba(255,255,255,0.06); color:var(--ui); pointer-events:auto;">Back</button>
          </div>
        </div>

        <!-- Controls tab content -->
        <div id="settings-tab-controls" style="display:none; max-width:360px;">
          <div style="display:flex; flex-direction:column; gap:8px; align-items:stretch;">
            <div style="font-weight:700; color:var(--ui); text-align:left;">Controls</div>
            <div id="controls-list" style="max-height:240px; overflow:auto; padding:6px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));">
              <!-- JS will populate control bindings here -->
            </div>

            <!-- Preset binding buttons -->
            <div style="display:flex; gap:8px; margin-top:8px; justify-content:center; align-items:center;">
              <button id="preset-wasd" type="button" style="pointer-events:auto; padding:8px; border-radius:8px; border:0; background:var(--accent); color:#04201b; min-width:120px;">WASD movement</button>
              <button id="preset-arrows" type="button" style="pointer-events:auto; padding:8px; border-radius:8px; border:0; background:rgba(255,255,255,0.06); color:var(--ui); min-width:120px;">ArrowKey movement</button>
            </div>

            <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,0.7); text-align:center;">
              Click a binding to reassign a key; press Escape to cancel. Changes apply immediately in-session.
            </div>
            <div class="pause-actions" style="margin-top:12px; justify-content:center;">
              <button id="controls-reset" type="button" style="min-width:120px; background:rgba(255,255,255,0.06); color:var(--ui); pointer-events:auto;">Reset to Defaults</button>
            </div>

            <!-- Back button for Controls tab -->
            <div class="pause-actions" style="margin-top:12px; justify-content:center;">
              <button id="settings-back-controls" type="button" style="min-width:120px; background:rgba(255,255,255,0.06); color:var(--ui); pointer-events:auto;">Back</button>
            </div>
          </div>
        </div>

        <!-- Environment tab content -->
        <div id="settings-tab-env" style="display:none;">
          <div style="display:flex; gap:8px; margin-bottom:10px; justify-content:center;">
            <button class="subtab-btn active" data-sub="objects" type="button" style="pointer-events:auto; padding:6px 8px; border-radius:8px; border:0; background:var(--accent); color:#04201b; font-weight:700;">Objects</button>
            <!-- placeholder for future env subtabs -->
            <button class="subtab-btn" data-sub="world" type="button" style="pointer-events:auto; padding:6px 8px; border-radius:8px; border:0; background:rgba(255,255,255,0.04); color:var(--ui);">World</button>
          </div>

          <!-- Objects controls: populated dynamically by JS -->
          <div id="objects-controls" style="max-height:220px; overflow:auto; padding:6px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));">
            <!-- JS will inject numbered controls here -->
          </div>
          <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,0.7); text-align:center;">
            Change box width & height per numbered object; changes apply immediately.
          </div>

          <!-- Back button shown only for the Objects subtab (JS toggles visibility) -->
          <div class="pause-actions" style="margin-top:10px; justify-content:center;">
            <button id="settings-back-env" type="button" style="min-width:120px; background:rgba(255,255,255,0.06); color:var(--ui); pointer-events:auto;">Back</button>
          </div>

        </div>

        <!-- insert World subtab content inside the Environment tab so background controls live within Environment -->
          <div id="settings-tab-world" style="display:none; max-width:360px;">
            <div style="display:flex; flex-direction:column; gap:8px; align-items:stretch;">
              <div style="font-weight:700; color:var(--ui); text-align:left;">Background</div>

              <label style="font-size:13px; color:var(--ui); display:flex; justify-content:space-between; align-items:center;">
                Solid color
                <input id="bg-color" type="color" value="#071018" style="margin-left:8px; pointer-events:auto;">
              </label>

              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1;">
                  <label style="font-size:13px; color:var(--ui); display:block; margin-bottom:6px;">Gradient presets</label>
                  <select id="bg-gradient-presets" style="width:100%; pointer-events:auto; padding:6px; border-radius:6px; background:rgba(255,255,255,0.03); color:var(--ui);">
                    <option value="">— choose preset —</option>
                    <option value="linear-gradient(180deg,#0d0f12 0%, #071018 100%)">Deep</option>
                    <option value="linear-gradient(180deg,#072b2a 0%, #03221f 100%)">Teal dusk</option>
                    <option value="linear-gradient(180deg,#111827 0%, #0b1220 100%)">Night</option>
                    <option value="linear-gradient(90deg,#ff8a00 0%, #e52e71 100%)">Warm</option>
                  </select>
                </div>
                <button id="apply-gradient" type="button" style="pointer-events:auto; padding:8px; border-radius:8px; border:0; background:var(--accent); color:#04201b;">Apply</button>
              </div>

              <label style="font-size:13px; color:var(--ui); display:block;">
                Custom CSS gradient
                <input id="bg-gradient-css" type="text" placeholder="e.g. linear-gradient(90deg,#fff,#000)" style="width:100%; margin-top:6px; padding:8px; border-radius:6px; border:0; background:rgba(255,255,255,0.03); color:var(--ui); pointer-events:auto;">
              </label>

              <div style="font-size:13px; color:var(--ui);">Image background</div>
              <label style="font-size:13px; color:var(--ui); display:flex; gap:8px; align-items:center;">
                URL
                <input id="bg-image-url" type="url" placeholder="https://…" style="flex:1; padding:8px; border-radius:6px; border:0; background:rgba(255,255,255,0.03); color:var(--ui); pointer-events:auto;">
                <button id="apply-bg-url" type="button" style="pointer-events:auto; padding:8px; border-radius:8px; border:0; background:var(--accent); color:#04201b;">Load</button>
              </label>

              <label style="font-size:13px; color:var(--ui); display:flex; gap:8px; align-items:center;">
                Upload
                <input id="bg-image-file" type="file" accept="image/*" style="flex:1; pointer-events:auto;">
              </label>

              <div style="display:flex; gap:8px; justify-content:space-between;">
                <button id="bg-reset" type="button" style="pointer-events:auto; padding:8px; border-radius:8px; border:0; background:rgba(255,255,255,0.06); color:var(--ui);">Reset</button>
                <div style="font-size:12px; color:rgba(255,255,255,0.7); align-self:center;">Solid / gradient apply to page background; image uses the scene texture where possible.</div>
              </div>

              <!-- Note and quick navigation: changes apply immediately for background controls -->
              <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,0.7); text-align:center;">
                Changes apply immediately
              </div>

              <!-- Back button placed inside Settings for consistent behavior -->
              <div class="pause-actions" style="margin-top:12px; justify-content:center;">
                <button id="settings-back" type="button" style="min-width:120px;">Back</button>
              </div>

            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <script type="module" src="main.js"></script>
</body>
</html>